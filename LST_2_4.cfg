% Configuration file for LSTs number two to four

#ifndef TYPE_CLASS
#  define TYPE_CLASS large-size telescope
#endif
#ifndef OPTICS_CLASS
#  define OPTICS_CLASS 1
#endif
#ifndef TRIGGER_CLASS
#  define TRIGGER_CLASS 2
#endif

#ifndef PROJECT
# define PROJECT CTA
#endif
#ifndef PRODVERS
# define PRODVERS PROD6
# define PRODVERS_TEXT Prod-6
#endif

#define LST_CONFIG 1

#if undefined(CTA_NORTH) && undefined(CTA_SOUTH)
# if defined(LST1) || defined(LST2) || defined(LST3) || defined(LST4)
#  defined CTA_NORTH 1
# else
echo 
echo --------------------------------------------------------------------------
echo Attempt to configure a generic LST without decision on CTA North or South.
echo This configuration might fail to work.
echo --------------------------------------------------------------------------
echo 
# endif
#endif

#include <site.cfg>
#include <common.cfg>
#include <CTA-PROD4-pmt.cfg>

% The remainder is specific for LST.

% ------------------------- Optical parameters --------------------------

optics_config_name = LST
optics_config_version = 2022-07-01 ($(PRODVERS_TEXT))  % Latest change: tuning thresholds for prod-6
#define TELIDNAME LST (unspecified)

parabolic_dish      = 1        % Mirrors are on a parabolic dish.
focal_length        = 2800     % Nominal focal length [cm]. Effective focal length is 2930.6 cm based on optical ray-tracing.
effective_focal_length = 2930.565 % Only to be used for image analysis. No effect in simulation itself.
mirror_focal_length = 0        % Adapted automatically unless specified in file (idea is to have three groups or sort)
% mirror_focal_length = 2862   % If using a single fixed focal length for a genuine parabolic dish [cm]
dish_shape_length   = 2800     % Same as nominal focal length for strictly parabolic design

#ifdef PERFECT_DISH

  % If all mirrors are just perfect:
  mirror_list         = mirror_CTA-LST-v20141201-198.dat   % 388.38 m^2 projected
  random_focal_length            = 0.,0

  mirror_reflection_random_angle = 0.0
  mirror_align_random_distance   = 0.0
  mirror_align_random_horizontal = 0.0,0.,0.,0.
  mirror_align_random_vertical   = 0.0,0.,0.,0.

#else

  % Better try to use a realistic configuration:
# ifdef LST_MIRRORS_GROUPED
   mirror_list         = mirror_CTA-LST-flen_grouped.dat   % Three groups of focal lengths (negative flen values! random flen still applies)
   random_focal_length =  0,20    % Assume flat distribution with a maximum of +-20 cm deviation from the given focal length
%  Alternative for older sim_telarray versions
%   random_focal_length = 11.5     % = 40/sqrt(12.) Gaussian distribution of same r.m.s.
    optics_config_variant = LST mirrors with grouped focal lengths
# else
#  if defined(CTA_SOUTH) || defined(LSTS)
    echo Using mirror list for CTA-South LSTs.
    mirror_list         = mirror_CTA-S-LST_v2020-04-07.dat   % Based on CTA-North LST 2-4 average of individual facet focal lengths.
    optics_config_variant = LSTS-xx
#   define TELIDNAME LSTS-xx
#   ifndef LSTS
#    define LSTS 1
#   endif
#  elif ( defined(LST1_PROTOTYPE) || ( defined(CTA_NORTH) && TELESCOPE == 1 && undefined(LST2) && undefined(LST3) && undefined(LST4) ) || defined(LST1) )
    echo Using mirror list for CTA-North LST-1.
    mirror_list         = mirror_CTA-N-LST1_v2019-03-31.dat  % Individual focal lengths
    optics_config_variant = LSTN-01
#   define TELIDNAME LSTN-01
#   ifndef LST1
#    define LST1 1
#   endif
#   ifndef LST1_PROTOTYPE
#    define LST1_PROTOTYPE 1
#   endif
#  elif ( ( defined(CTA_NORTH) && TELESCOPE == 2 ) || defined(LST2) )
    echo Using mirror list for CTA-North LST-2.
    mirror_list         = mirror_CTA-N-LST2_v2020-04-07.dat  % Individual focal lengths
    optics_config_variant = LSTN-02
#   define TELIDNAME LSTN-02
#   ifndef LST2
#    define LST2 1
#   endif
#  elif ( ( defined(CTA_NORTH) && TELESCOPE == 3 ) || defined(LST3) )
    echo Using mirror list for CTA-North LST-3.
    mirror_list         = mirror_CTA-N-LST3_v2020-04-07.dat  % Individual focal lengths
    optics_config_variant = LSTN-03
#   define TELIDNAME LSTN-03
#   ifndef LST3
#    define LST3 1
#   endif
#  elif ( ( defined(CTA_NORTH) && TELESCOPE == 4 ) || defined(LST4) )
    echo Using mirror list for CTA-North LST-4.
    mirror_list         = mirror_CTA-N-LST4_v2020-04-07.dat  % Individual focal lengths
    optics_config_variant = LSTN-04
#   define TELIDNAME LSTN-04
#   ifndef LST4
#    define LST4 1
#   endif
#  else
    echo Using mirror list for unknown LST.
    mirror_list         = mirror_CTA-S-LST_v2020-04-07.dat   % Based on CTA-North LST 2-4 average of individual facet focal lengths.
#  endif
   random_focal_length =  0,0                               % without extra randomness.
# endif

%  mirror_reflection_random_angle = 0.0075 % [deg] based on 2-f measurements of single mirror segments.

  mirror_align_random_distance    = 0.0 % cm

% LST-1 cumulative PSF distribution reproduced with worse mirror alignment than initially assumed.
% The tail in the distribution could be due to very poorly aligned mirrors but we only have
% the second random reflection angle component to describe the PSF tail (12.5% with 0.037 deg.).
%  mirror_reflection_random_angle = 0.0075,0.125,0.037 % [deg] with tail in distribution needed to match telescope cumulative PSF distribution
%  mirror_align_random_horizontal = 0.0039,28.,0.0,0.0 % no zenith dependence due to active mirror control
%  mirror_align_random_vertical   = 0.0039,28.,0.0,0.0 % no zenith dependence due to active mirror control

% Update 2022-06-15 for better match with later LST-1 measurements.
  mirror_reflection_random_angle = 0.0075,0.22,0.0220 % [deg] with tail in distribution needed to match telescope cumulative PSF distribution
  mirror_align_random_horizontal = 0.0019,28.,0.,0.   % no zenith dependence due to active mirror control
  mirror_align_random_vertical   = 0.0019,28.,0.,0.   % no zenith dependence due to active mirror control

#endif

mirror_offset       = 93.25    % [cm] behind/below axes crossing (see redmine issue 35807)
focus_offset        = 6.55     % 1./(1./2800.-1./12.e5)-2800. (focusing at 12 km distance), starlight focusing target to pixel entrance

% mirror_reflectivity = ref_SANKO_29ave.dat % Updated prod-3 reflectivity (Masaaki et. al.)
% mirror_reflectivity = ref_200_1100_180314_ver2.1a.dat % Koji Noda, 2018-03-15
% mirror_reflectivity = ref_200_1100_190211a.dat % Revised version 2019-02-18, with better absolute calibration.
% mirror_reflectivity = ref_LST_2020-04-21.dat  % Revised version received 2020-04-21.
mirror_reflectivity = ref_LST_2020-04-23.dat  % Revised version received 2020-04-23.
mirror_degraded_reflection = 0.80             % Assuming future LSTs will degrade like LST-1
% Fixme: Individual (average per telescope) reflectivity curves to come (check if degrading would still apply!)
#if defined(LST1)
  mirror_reflectivity = ref_LST1_2022_04_01.dat  % for mirror on LST-1(N) by Yusuke Suda 2022-04-01
#elif defined(LST2)
  mirror_reflectivity = ref_LST2_2022_04_01.dat  % for mirror on LST-2(N) by Yusuke Suda 2022-04-01
#elif defined(LST3)
  mirror_reflectivity = ref_LST3_2022_04_01.dat  % for mirror on LST-3(N) by Yusuke Suda 2022-04-01
#elif defined(LST4)
  mirror_reflectivity = ref_LST4_2022_04_01.dat  % for mirror on LST-4(N) by Yusuke Suda 2022-04-01
#endif

% Accuracy of the tracking and measurement of current direction.
% Pointing errors can always be mimicked at the analysis level:
telescope_random_angle         = 0.
telescope_random_error         = 0.

% -------------------------- Camera ------------------------------

camera_config_name = LSTcam
camera_config_version = 2022-07-01 ($(PRODVERS_TEXT))
#if defined(NSB_AUTOSCALE) && undefined(FULLMOON) && undefined(HALFMOON)
  camera_config_variant $(TELIDNAME) camera, with auto-scaling NSB levels
# ifndef HAVE_MATHEVAL
  echo With auto-scaling NSB levels pre-evaluated (works without HAVE_MATHEVAL).
# endif
  echo NSB gets automatically scaled according to zenith angle.
#elif defined(HALFMOON)
  camera_config_variant $(TELIDNAME) camera, with HALFMOON settings
#elif defined(FULLMOON)
  camera_config_variant $(TELIDNAME) camera, with FULLMOON settings
#else
  camera_config_variant $(TELIDNAME) camera
#endif

% The telescope_transmission factor corrects for the shadowing by
% elements not explicitly included in sim_telarray. 
% It is thus the ratio of the effective optical area (in projection) based on a
% detailed ray-tracing with all elements over the same area in simplified
% ray-tracing by sim_telarray.
% The original evaluation by detailed ray-tracing (K.Noda, 2013, with ROBAST)
% resulted in an un-projected non-shadowed mirror area of 369.14+-0.08 m^2, from
% which after projection 365.2+-0.1 m^2 are expected. Re-evaluation in Dec. 2017
% resulted in 365.4 m^2 projected. All on-axis.
% Evaluation with sim_telarray results in 380.37+-0.07 m^2 with the 300 cm square
% camera body and 377.71+-0.07 m^2 with the 348 cm square camera body assumption
% including the mounting frame.

% Now using bigger camera body value (including mounting frame) by default.
camera_body_shape = 2        % Square camera body, needs newer sim_telarray
camera_body_diameter = 348   % cm (only for shadowing, includes mounting frame)
telescope_transmission = 0.9690 % = 366.0/377.71 with 348 cm camera body + frame accounted for explicitely.

camera_transmission = 1.0 % All of the transmission is now included in the camera_filter file.
camera_filter = transmission_lst_window_No7-10_ave.dat % same as No7-10_ave.dat but not percent (and with 1000 nm extrapol.)

#if defined(LST1_PROTOTYPE) || ( defined(CTA_NORTH) && defined(LST1) )
  % Like v2019-03-01 but lower QE pixels on the LST-1 camera edge, plus new and wider funnel efficiency table.
  camera_config_file = camera_CTA-LST-1_analogsum21_v2020-04-14.dat 
  quantum_efficiency = qe_lst1_20200318_high+low.dat % Only column for high QE pixels is active
  pm_gain_index = 4.50     % (+- 0.30) For 8-dynode PMTs with first dynode stabilized at 350 V.
  pm_transit_time = 24.74,9.0,350.,1066. % full and first dynode transit times at nominal voltage (8-dynode variant)
  pm_voltage_variation = 0.041 % random voltage variation at given gain (44.2/1065.5)
#else
  % Like v2019-03-01 but lower QE pixels on the LST-2/3/4 camera edge, plus new and wider funnel efficiency table.
  camera_config_file = camera_CTA-LST-234_analogsum21_v2020-04-14.dat 
  quantum_efficiency = qe_lst2-4_20200318_high+low.dat % Only column for high QE pixels is active
  pm_gain_index = 3.92     % (+- 0.11) For 7-dynode PMTs with first dynode stabilized at 350 V.
  pm_transit_time = 20.89,9.0,350.,1135. % full and first dynode transit times at nominal voltage (7-dynode variant)
  pm_voltage_variation = 0.03 % random voltage variation at given gain (33./1136., no difference between low and high QE)
#endif
qe_variation = 0.063  % based on LST-1 flat-fielding, including other efficiency variations than just QE itself (F.C./T.S. 2022-03-30)
gain_variation = 0.0187 % random gain variation after flatfielding adjustment (as in 1.87% rms of flatfielded HG signal)
fadc_var_sensitivity = 0.09 % Suggestion by FC 2022-03-29, instead of (unsupported) grouping of pixel noise.

#define ONLY_ANALOG_SUM 1
#define NO_MAJORITY 1
#define NO_DIGITAL_SUM 1

camera_pixels        = 1855  % needs to be specified explicitly

min_photons = 0            % With fewer photons don't waste CPU time.
min_photoelectrons = 0      % 50% efficiency at 70 p.e.
store_photoelectrons = 0    % Save individual photo-electrons
#ifdef LST_EXTREME_TRIGGER
  min_photons = 220            % With fewer photons don't waste CPU time.
  min_photoelectrons = 18      % 50% efficiency at 60 p.e.
  store_photoelectrons = 16    % Save individual photo-electrons
#endif

#if ( defined(LST1_PROTOTYPE) || ( defined(CTA_NORTH) && TELESCOPE == 1 && undefined(LST2) && undefined(LST3) && undefined(LST4) ) || defined(LST1) )

% NSB of LST-1 prototype is a bit lower than others due to a different QE curve. For reference NSB.
% Without auto-scaling we use the 20 deg value. For reference NSB.
# define NSB_DARK0    0.23359
# define NSB_DARK20   0.24130 
# define NSB_HALFMOON 1.17456 

#elif defined(CTA_NORTH)

# define NSB_DARK0    0.24154
# define NSB_DARK20   0.24951
# define NSB_HALFMOON 1.21092

#else

# define NSB_DARK0    0.24464
# define NSB_DARK20   0.25271
# define NSB_HALFMOON 1.22710

#endif

#define NSB_FULLMOON 6.1

#if defined(FULLMOON)
   nightsky_background = all:6.1         % Just a guess, as camera will be disabled anyway.
#elif defined(HALFMOON)
   echo Configuring for sky illuminated by half moon in LST.
   nightsky_background = all:$(NSB_HALFMOON)     % NSB at half moon
#else
# ifndef NSB_AUTOSCALE
     nightsky_background = all:$(NSB_DARK20) % For reference NSB.
# else
#  ifndef HAVE_MATHEVAL
     nightsky_background = all:$(NSB_DARK0) % With NSB autoscaling adjust to achieve same NSB at 20 deg zenith angle.
#  else
     nightsky_background = all:$[$(NSB_DARK20)/1.0330] % With NSB autoscaling adjust to achieve same NSB at 20 deg zenith angle.
# endif
     nsb_autoscale_airmass = 0.84,0.29  % Based on tuning with ESO Advanced Sky Model and testeff for MST NectarCam model.
# endif
#endif

% --------------- Placing of signals in simulated windows ---------------

% We need to shift the pulses further 'right' in the simulated time windows,
% such that the occasional early signals (at large core distance) are better covered.
photon_delay = 19    % ns

% --------------------------- Trigger -----------------------------------

% The trigger simulation is over a slightly earlier window than the ADC signals (from interval -3 to 64 in ADC frame).
disc_bins = 68  % Number of time intervals simulated for trigger.
disc_start = 3  % How many intervals the trigger simulation starts before the ADC.

% The camera config file has majority, analog sum, plus digital sum.
#ifndef NO_ANALOG_SUM
# define ANALOG_SUM 1
#endif

% Majority & analog sum input pulses:
% The high-gain input for the digitized signal is also considered a good approximation
% for the trigger channel input pulse shape (G.M.Botella, Suda Yusuke, 2020-02-20):
#if defined(LST1_PROTOTYPE) || defined(LST1)
   discriminator_pulse_shape = pulse_LST_8dynode_pix6_20200204.dat % data by Y. Kobayashi (ICRR), 2020-02-19.
#else
   discriminator_pulse_shape = LST_pulse_shape_7dynode_high_intensity_pix1s.dat % (2022-05)
#endif
discriminator_amplitude = 6.5 % (was 20.) % mV for mean p.e. amplitude

% Discriminator threshold (and corresponding multiplicity for telescope trigger):
trigger_pixels = 3             % This means actually a level of 2.5 pixels. Not used for analog sum.
discriminator_threshold = 99999

% Telescope trigger (specified even if no majority trigger is used):
default_trigger = AnalogSum
teltrig_min_time                       0.5 % ns
teltrig_min_sigsum                     7.8 % pV.s

% With a single trigger type no delay compensation between trigger types needed.
% Could be used though for systematic differences between telescope types.
trigger_delay_compensation = all: 0 

asum_threshold = 260.7 % Aggressive trigger (limit at 2x dark).
asum_clipping = 9999   % Effectively no clipping used any more.

% None of the non-standard settings evaluated for prod-6, so commenting them out for now.
% #ifdef LST_SAFE_TRIGGER
%   asum_threshold = 296 % mV, resulting in 8 kHz accidental single rate (NSB rate ~ CR single rate) at twice "dark" NSB.
%   asum_clipping = 9999 % mV (effectively no clipping)
%   % No high-NSB threshold values known for safe trigger mode
% #endif
% #ifdef LST_EXTREME_TRIGGER
%   asum_threshold = 230 % mV, extreme threshold: stereo (2/4 tel.) NSB random rate at 1x dark = 0.1 * CR stereo (2/4), single rate is about 40 kHz (unstable!!)
%   asum_clipping = 9999 % mV (effectively no clipping)
%   % No high-NSB threshold values known for extreme trigger mode
% #endif

#ifdef HALFMOON
  asum_threshold = 319.1  % Aggressive trigger (limit at partial moon).
#endif

% #ifdef THRESHOLD_5X
%   asum_threshold = 360.  % Aggressive trigger (limit at 5x dark, ~partial moon)
%   trigger_current_limit = 2000.0 % [microAmps] 
%   nsb_scaling_factor = 5 
%   Error No threshold value yet for 5x dark NSB level
% #endif
% #ifdef THRESHOLD_7X
%   asum_threshold = 400.  % Aggressive trigger (limit at 7x dark)
%   trigger_current_limit = 2000.0 % [microAmps] 
%   nsb_scaling_factor = 5 % Yes simulation is actually at 5x dark NSB.
%   Error No threshold value yet for up to 7x dark NSB level
% #endif
% #ifdef THRESHOLD_30X
%   trigger_current_limit = 2000.0 % [microAmps] 
%   nsb_scaling_factor = 30
%   min_photons = 100000000  % Bypass processing this telescope as early as possible
%   Echo Effectively disabled at 30x dark NSB.
% #endif

#ifdef FULLMOON
  trigger_current_limit = 2000.0 % [microAmps] 
  discriminator_threshold = 10000 % never triggers
  asum_threshold = 10000 % never triggers
  min_photons = 100000000  % Bypass processing this telescope as early as possible
  Echo Effectively disabled LST at full-moon level NSB.
#endif

asum_shaping_file = none % No further shaping needed - pulse is wide enough.
asum_offset = 0.0

% only_triggered_arrays=0
only_triggered_telescopes=1

% ------------------------------ Readout --------------------------------

% Sampling rate in MHz:
fadc_MHz = 1024 % MHz sampling rate

#ifdef LST1_PROTOTYPE
   fadc_pulse_shape = pulse_LST_8dynode_pix6_20200204.dat % data by Y. Kobayashi (ICRR), 2020-02-19.
#else
   fadc_pulse_shape = LST_pulse_shape_7dynode_high_intensity_pix1s.dat % (2022-05)
#endif

% Read-out of a 40 ns window (within simulated 55 ns) following the actual trigger:
fadc_bins = 75       % Number of time intervals simulated for ADC (extends by 10 ns beyond the 68 ns discriminator simulation)
fadc_sum_bins = 40   % Number of ADC time intervals actually summed up or written as trace.
fadc_sum_offset = 9  % How many intervals summation starts before telescope trigger.

fadc_pedestal = 246          % Per time slice (positive signals only: unsigned!)
fadc_err_pedestal = 0.5      % The reported pedestal differs from what gets internal used.
fadc_var_pedestal = 30.      % Channel-to-channel r.m.s. differences.
fadc_amplitude = 25.0        % The peak amplitude in a time slice for high gain.
% fadc_noise = 6.33            % Derived from 6 samples integration window for white-noise assumption.
fadc_noise = 6.7             % Derived from 6 samples integration window for white-noise assumption. (?)

num_gains = 2                % Make it clear that we want to use two gains
fadc_lg_pedestal = 207       % Per time slice (positive signals only: unsigned!)
fadc_lg_err_pedestal = 0.3   % The reported pedestal differs from what gets internal used.
fadc_lg_var_pedestal = 31.   % Channel-to-channel r.m.s. differences.
fadc_lg_amplitude = 1.28     % The peak amplitude in a time slice for low gain (HG/LG=19.5, according to Seiya Nozaki)
% fadc_lg_noise = 5.34         % Derived from 6 samples integration window for white-noise assumption.
fadc_lg_noise = 5.7          % Derived from 6 samples integration window for white-noise assumption. (?)

fadc_max_signal = 4095       % 12-bit ADC (applies to both channels unless specified)
fadc_max_sum = 16777215      % 24-bit sum is unlimited for all practical purposes.

#ifndef NO_PROCESSED_PEDESTALS
% The camera server is supposed to not only fix up capacitor-by-capacitor raw-level calibration
% but likely also applying a uniform computed pedestal.
% Consequences of that on the overflow values are not clear yet.
fadc_pedestal = 400.
fadc_lg_pedestal = 400.
fadc_var_pedestal = 0.4      % All pedestals equal within +-0.5 counts plus some error in evaluating it.
fadc_lg_var_pedestal = 0.4
fadc_max_signal = 4249       % 4095 + 400 - 246 for the processed ("pre-calibrated") high-gain traces, average
fadc_lg_max_signal = 4288    % 4095 + 400 - 207 for the processed ("pre-calibrated") low-gain traces, average
#endif

% ----------------------------- Analysis --------------------------------

#ifdef WITH_PULSE_ANALYSIS
% Pulse shape analysis with pulse sum around global peak
% position only for significant pixels.
pulse_analysis = -30

% Pulse analysis provides a conditional 8 ns integration at 1000 MHz sampling rate.
sum_before_peak = 3
sum_after_peak = 4

tailcut_scale = 2.6 % For built-in image cleaning (not relevant for later analysis)
#endif



% Add any changed parameters below ...

echo LST configuration adapted for Prod-6

effective_focal_length = 2923.7 % Old style (one value) for backward compatible data.
#ifdef ASYMMETRIC_FLEN
% Mean effective focal length, eflen for x proj., eflen for y proj., displacements in x/y.
  effective_focal_length = 2923.7, 2927.8, 2919.5, 0., 0. 
#endif
